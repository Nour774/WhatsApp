<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
<style>
body { margin:0; font-family:Tahoma, sans-serif; background:#f0f0f0; display:flex; flex-direction:column; height:100vh; }
#chat-container { flex:1; display:flex; flex-direction:column; padding:10px; overflow:hidden; }
#messages-list { flex:1; overflow-y:auto; padding:0; margin:0; list-style:none; }
#messages-list li { margin:5px 0; max-width:70%; padding:8px 12px; border-radius:15px; position:relative; word-wrap:break-word; display:flex; flex-direction:column; }
#messages-list li.self { background:#6a0572; color:#fff; align-self:flex-end; }
#messages-list li.other { background:#ddd; color:#000; align-self:flex-start; }
#messages-list li.admin { background:#fffae5; color:#000; align-self:center; }
.message-header { font-size:12px; font-weight:700; margin-bottom:3px; display:flex; justify-content:space-between; }
.message-time { font-size:10px; color:#555; margin-left:5px; }
.reactions-container { display:flex; flex-wrap:wrap; margin-top:4px; }
.reaction { cursor:pointer; margin-inline-end:3px; font-size:14px; }
#message-input-area { display:flex; padding:10px; background:#fff; align-items:center; }
#message-input-area input[type="text"] { flex:1; padding:10px 12px; border-radius:20px; border:1px solid #ccc; outline:none; }
#message-input-area button { margin-inline-start:8px; padding:10px; border:none; border-radius:50%; cursor:pointer; background:#6a0572; color:#fff; font-size:18px; display:flex; align-items:center; justify-content:center; }
#send-btn { width:40px; height:40px; clip-path: polygon(0% 0%, 100% 50%, 0% 100%); background:#6a0572; color:#fff; font-size:0; }
.emoji-picker { position:absolute; background:#fff; border:1px solid #ccc; border-radius:8px; padding:5px; display:none; z-index:100; }
.emoji-picker span { cursor:pointer; padding:2px; font-size:18px; }
.reply-preview { font-size:11px; color:#333; margin-bottom:2px; background:#eee; padding:2px 4px; border-radius:5px; }
img, video { max-width:200px; border-radius:8px; margin-top:3px; }
</style>
</head>
<body>

<div id="chat-container">
  <ul id="messages-list"></ul>
  <div id="message-input-area">
    <button id="attach-btn">+</button>
    <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
    <button id="send-btn"></button>
  </div>
</div>

<div id="emoji-picker" class="emoji-picker">
  <span>ğŸ˜€</span><span>ğŸ˜‚</span><span>ğŸ˜</span><span>ğŸ˜</span><span>ğŸ‘</span><span>ğŸ‰</span>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
// ================= Supabase =================
const SUPABASE_URL = "https://hmamaaqtnzevrrmgtgxk.supabase.co";
const SUPABASE_ANON = "YOUR_SUPABASE_ANON_KEY";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// ================= Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =================
const currentUserId = localStorage.getItem('chat_user_id');
const currentUsername = localStorage.getItem('chat_username');
if(!currentUserId || !currentUsername){
  alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...');
  window.location.href='login.html';
}

// ================= Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© =================
const messagesList = document.getElementById('messages-list');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const attachBtn = document.getElementById('attach-btn');
const emojiPicker = document.getElementById('emoji-picker');
let replyToId = null;

// ================= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =================
async function loadMessages(){
  const { data: messages, error } = await supabase
    .from('chat')
    .select('*, reactions(*), sender_id(username,role)')
    .order('created_at', { ascending:true });
  if(error){ console.error(error); return; }
  messagesList.innerHTML='';
  messages.forEach(renderMessage);
  messagesList.scrollTop = messagesList.scrollHeight;
}

// ================= Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =================
function renderMessage(msg){
  const li = document.createElement('li');
  if(msg.sender_id.id===currentUserId) li.className='self';
  else if(msg.sender_id.role==='admin') li.className='admin';
  else li.className='other';

  let header = `<div class="message-header">${msg.sender_id.username}<span class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</span></div>`;
  let reply = msg.reply_to ? `<div class="reply-preview">Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© #${msg.reply_to}</div>` : '';
  let content = '';
  if(msg.type==='text') content = `<div>${msg.message}</div>`;
  else if(msg.type==='image') content=`<img src="${msg.media_url}">`;
  else if(msg.type==='video') content=`<video src="${msg.media_url}" controls></video>`;

  li.innerHTML = header + reply + content;

  // Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
  const reactionsDiv = document.createElement('div');
  reactionsDiv.className='reactions-container';
  if(msg.reactions) msg.reactions.forEach(r=>{
    const span=document.createElement('span');
    span.className='reaction';
    span.textContent = r.emoji;
    span.onclick=async e=>{
      e.stopPropagation();
      if(r.user_id===currentUserId){ await supabase.from('reactions').delete().eq('id',r.id); loadMessages(); }
    };
    reactionsDiv.appendChild(span);
  });
  li.appendChild(reactionsDiv);

  // Ø§Ù„Ø±Ø¯ ÙˆÙØªØ­ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
  li.onclick = e=>{
    replyToId = msg.id;
    emojiPicker.style.display='block';
    emojiPicker.style.top=(e.clientY+5)+'px';
    emojiPicker.style.left=(e.clientX+5)+'px';
    emojiPicker.dataset.chatId=msg.id;
  };

  messagesList.appendChild(li);
}

// ================= Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =================
async function sendMessage(){
  const text = messageInput.value.trim();
  if(!text && !replyToId) return;
  const { data, error } = await supabase.from('chat')
    .insert([{ sender_id: currentUserId, message:text, reply_to:replyToId, type:'text' }])
    .select()
    .maybeSingle();
  if(error){ console.error(error); return; }
  loadMessages();
  messageInput.value=''; replyToId=null;
}

// ================= Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª =================
attachBtn.onclick=()=>{
  const fileInput=document.createElement('input');
  fileInput.type='file';
  fileInput.accept='image/*,video/*';
  fileInput.onchange=async ()=>{
    if(!fileInput.files[0]) return;
    const f=fileInput.files[0];
    const ext=f.name.split('.').pop();
    const fileName=`${currentUserId}_${Date.now()}.${ext}`;
    const { data: storageData, error } = await supabase.storage.from('chat-media').upload(fileName,f);
    if(error){ console.error(error); return; }
    const url = supabase.storage.from('chat-media').getPublicUrl(fileName).publicUrl;
    const type = f.type.startsWith('image')?'image':'video';
    await supabase.from('chat').insert([{ sender_id: currentUserId, media_url:url, type }]);
    loadMessages();
  };
  fileInput.click();
};

// ================= Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ =================
emojiPicker.querySelectorAll('span').forEach(span=>{
  span.onclick=async ()=>{
    const chatId=emojiPicker.dataset.chatId;
    const emoji=span.textContent;
    const { data: exists } = await supabase.from('reactions')
      .select('id').eq('chat_id',chatId).eq('user_id',currentUserId).eq('emoji',emoji).maybeSingle();
    if(exists){ await supabase.from('reactions').delete().eq('id',exists.id); }
    else{ await supabase.from('reactions').insert([{chat_id:chatId,user_id:currentUserId,emoji}]); }
    emojiPicker.style.display='none';
    loadMessages();
  };
});

// ================= Ø£Ø­Ø¯Ø§Ø« =================
sendBtn.onclick = sendMessage;
messageInput.addEventListener('keypress', e=>{ if(e.key==='Enter'){ sendMessage(); e.preventDefault(); }});

// ================= ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ =================
loadMessages();
setInterval(loadMessages,3000);
</script>

</body>
</html>
