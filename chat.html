<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --accent:#6a0572;
    --accent-2:#b5173a;
    --bubble-self: linear-gradient(135deg,var(--accent),#8a2a7a);
    --bubble-other:#ffffff;
    --text-self:#ffffff;
    --text-other:#222;
    --max-bubble-width:78%;
    --composer-height:72px;
  }

  html,body{height:100%;margin:0;font-family:"Tahoma",sans-serif;background:#f2f2f2; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ø·Ø¨Ù‚Ø© Ø¶Ø¨Ø§Ø¨ÙŠØ© */
  body::before{
    content:"";
    position:fixed;inset:0;
    background-image:url('images/img.jpg');
    background-size:cover;background-position:center;
    filter:blur(6px) brightness(.55);
    z-index:0;
  }

  #app{position:relative;z-index:1;display:flex;flex-direction:column;height:100vh;backdrop-filter: none;max-width:1200px;margin:0 auto;}
  header{padding:12px 14px;color:#fff;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.06));backdrop-filter: blur(4px);z-index:20}
  header .title{font-weight:700;font-size:18px;text-shadow:0 1px 6px rgba(0,0,0,.45)}
  header .subtitle{font-size:13px;opacity:.95;color:#fff}

  #chat-container{flex:1;display:flex;flex-direction:column;padding:10px;gap:8px;width:100%;}
  #messages-list{flex:1;overflow:auto;padding:12px 8px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth; -webkit-overflow-scrolling:touch;}
  /* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
  .msg {
    padding:10px 12px;
    border-radius:18px;
    word-break:break-word;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
    max-width:var(--max-bubble-width);
    position:relative;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .msg .meta{font-size:12px;opacity:.85;display:flex;justify-content:space-between;align-items:center;gap:8px;}
  .msg .username{font-weight:700;margin-inline-start:6px}
  .msg .time{font-size:11px;color:rgba(0,0,0,.45);margin-inline-end:6px}
  .msg.self{align-self:flex-end;background:var(--bubble-self);color:var(--text-self); border-bottom-right-radius:6px}
  .msg.other{align-self:flex-start;background:var(--bubble-other);color:var(--text-other); border-bottom-left-radius:6px}
  /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ */
  .msg img, .msg video, .msg audio{max-width:320px;max-height:320px;border-radius:10px;display:block}
  .msg p{margin:0;white-space:pre-wrap;word-wrap:break-word}
  .msg .actions{display:flex;gap:8px;align-items:center;margin-top:4px;flex-wrap:wrap}
  .reaction-pill{background:rgba(255,255,255,.9);padding:4px 8px;border-radius:999px;font-size:13px;box-shadow:0 1px 3px rgba(0,0,0,.08);cursor:pointer;border: none}
  .reaction-pill.active{box-shadow:0 1px 4px rgba(0,0,0,.18);transform:translateY(-1px)}
  .msg .menu-btn{position:absolute;left:8px;top:8px;background:transparent;border:none;color:rgba(255,255,255,.7);cursor:pointer;font-size:14px}

  /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
  #composer{display:flex;gap:8px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.95));backdrop-filter: blur(6px);align-items:center;position:sticky;bottom:0;z-index:15}
  #composer .left-controls{display:flex;gap:8px;align-items:center}
  #composer textarea{flex:1;min-height:44px;max-height:180px;padding:12px 14px;border-radius:18px;border:1px solid rgba(0,0,0,.08);outline:none;font-size:15px;resize:none;background:transparent}
  #composer .btn{width:44px;height:44px;border-radius:50%;border:none;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
  #composer .btn.attach{background:transparent;border:1px solid rgba(0,0,0,.08);color:#333}
  #composer .preview{display:flex;gap:8px;align-items:center;padding:6px;background:rgba(0,0,0,0.04);border-radius:8px}
  .file-thumb{max-width:64px;max-height:48px;border-radius:6px;object-fit:cover}
  .file-info{font-size:13px;color:#222;direction:rtl}

  /* Ø±Ø¯ÙˆØ¯ (preview Ø¯Ø§Ø®Ù„ composer) */
  .reply-preview{background:rgba(0,0,0,0.06);padding:8px;border-radius:8px;font-size:13px;color:rgba(0,0,0,.75);display:flex;justify-content:space-between;align-items:center;gap:8px}

  /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (Ù…Ø±ÙƒØ²ÙŠØ© ÙˆØªØªØ­ÙƒÙ… ÙÙŠ overflow) */
  #emoji-picker{position:fixed;display:none;gap:8px;padding:8px;background:rgba(255,255,255,0.98);border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.18);z-index:120;align-items:center;justify-content:center;flex-wrap:wrap;max-width:90vw;max-height:45vh;overflow:auto}
  #emoji-picker button{font-size:22px;padding:6px;border-radius:8px;border:none;background:transparent;cursor:pointer}
  #emoji-picker[aria-hidden="false"]{display:flex}

  /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù‡Ø§ØªÙ */
  @media(max-width:900px){
    :root{--max-bubble-width:92%}
    header .title{font-size:16px}
    .msg img,.msg video{max-width:72vw}
    #app{padding:0 6px}
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="title">Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</div>
    <div class="subtitle">Ù…Ø±Ø­Ø¨Ø§ØŒ <strong id="me-name"></strong></div>
  </header>

  <main id="chat-container" role="main" aria-labelledby="me-name">
    <ul id="messages-list" aria-live="polite" role="list"></ul>

    <div id="composer" role="region" aria-label="Ù…Ù†Ø·Ù‚Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„">
      <div class="left-controls">
        <button id="attach-btn" class="btn attach" title="Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù">ğŸ“</button>
      </div>

      <div style="flex:1;display:flex;flex-direction:column;gap:8px">
        <div id="reply-area" style="display:none" class="reply-preview" aria-hidden="true">
          <div id="reply-text" style="flex:1"></div>
          <button id="cancel-reply" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¯" class="btn" style="width:34px;height:34px;background:#eee;color:#333;font-size:14px">Ã—</button>
        </div>

        <textarea id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." aria-label="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©" rows="1"></textarea>

        <div id="attach-preview" style="display:none" aria-hidden="true">
          <div class="preview" id="preview-content"></div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:6px;align-items:center">
        <button id="send-btn" class="btn" title="Ø¥Ø±Ø³Ø§Ù„">â–¶</button>
      </div>
    </div>
  </main>
</div>

<!-- Emoji picker -->
<div id="emoji-picker" role="dialog" aria-hidden="true" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§ÙŠÙ…ÙˆØ¬ÙŠ" tabindex="-1"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
/* ----------- Ø¥Ø¹Ø¯Ø§Ø¯ Supabase (Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹) ------------ */
const SUPABASE_URL = "https://hmamaaqtnzevrrmgtgxk.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtYW1hYXF0bnpldnJybWd0Z3hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTgzMDAsImV4cCI6MjA3NzkzNDMwMH0.tk_S2URpkYvf8xnsPJl3Dqh4jzKwhVm0alWl8oHo-SE";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ----------- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ----------- */
const currentUserId = localStorage.getItem('chat_user_id');
const currentUsername = localStorage.getItem('chat_username');
if(!currentUserId || !currentUsername){
  // Ø¥Ù† Ù„Ù… ÙŠØªÙˆÙØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¹ÙŠØ¯Ù‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
  alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø› Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.');
  window.location.href = 'login.html';
}
document.getElementById('me-name').textContent = currentUsername;

/* ----------- Ø¹Ù†Ø§ØµØ± DOM ----------- */
const messagesList = document.getElementById('messages-list');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const attachBtn = document.getElementById('attach-btn');
const emojiPicker = document.getElementById('emoji-picker');
const replyArea = document.getElementById('reply-area');
const replyText = document.getElementById('reply-text');
const cancelReplyBtn = document.getElementById('cancel-reply');
const attachPreview = document.getElementById('attach-preview');
const previewContent = document.getElementById('preview-content');

let longPressTimer = null;
let longPressTargetId = null;
let pendingReplyTo = null;
let pendingMedia = null; // { type, url, name }
let uploading = false;

/* ---------- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª ---------- */
function formatTime(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString('ar-EG', { hour:'2-digit', minute:'2-digit' });
  }catch(e){ return iso; }
}

/* ---------- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---------- */
async function loadMessages(){
  try{
    const { data, error } = await supabase
      .from('chat')
      .select('id,sender_id,message,media_url,type,reply_to,created_at,profiles(username),reactions(id,emoji,user_id)')
      .order('created_at', { ascending: true });

    if(error){ console.error('loadMessages error', error); return; }
    messagesList.innerHTML = '';
    const msgMap = {};
    data.forEach(m => msgMap[m.id] = m);
    data.forEach(msg => renderMessage(msg, msgMap));
    messagesList.scrollTop = messagesList.scrollHeight;
  }catch(err){
    console.error('unexpected loadMessages', err);
  }
}

/* ---------- Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ---------- */
function renderMessage(msg, msgMap = {}){
  const li = document.createElement('li');
  li.className = 'msg ' + (msg.sender_id === currentUserId ? 'self' : 'other');
  li.dataset.msgId = msg.id;
  li.setAttribute('role','listitem');

  const meta = document.createElement('div');
  meta.className = 'meta';

  const nameSpan = document.createElement('span');
  nameSpan.className = 'username';
  nameSpan.textContent = (msg.profiles && msg.profiles.username) ? msg.profiles.username : 'Ù…Ø³ØªØ®Ø¯Ù…';

  const timeSpan = document.createElement('span');
  timeSpan.className = 'time';
  timeSpan.textContent = formatTime(msg.created_at);

  meta.appendChild(timeSpan);
  meta.appendChild(nameSpan);
  li.appendChild(meta);

  if(msg.reply_to){
    const original = msgMap[msg.reply_to];
    const replyBox = document.createElement('div');
    replyBox.className = 'reply-box';
    const excerpt = original ? (original.message ? original.message.slice(0,140) : (original.media_url ? '[ÙˆØ³Ø§Ø¦Ø·]' : '')) : '';
    replyBox.textContent = original ? `Ø±Ø¯ Ø¹Ù„Ù‰ ${original.profiles?.username || 'Ù…Ø³ØªØ®Ø¯Ù…'}: ${excerpt}${excerpt ? '...' : ''}` : 'Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©';
    replyBox.style.background = 'rgba(0,0,0,0.04)';
    replyBox.style.padding = '6px 8px';
    replyBox.style.borderRadius = '8px';
    li.appendChild(replyBox);
  }

  if(msg.message && msg.message.trim() !== ''){
    const p = document.createElement('p');
    p.textContent = msg.message;
    li.appendChild(p);
  }

  if(msg.media_url){
    if(msg.type === 'video'){
      const v = document.createElement('video');
      v.src = msg.media_url;
      v.controls = true;
      v.style.maxWidth = '100%';
      v.style.borderRadius = '8px';
      li.appendChild(v);
    } else if(msg.type === 'audio'){
      const a = document.createElement('audio');
      a.src = msg.media_url;
      a.controls = true;
      li.appendChild(a);
    } else {
      // image or generic file icon
      try{
        const img = document.createElement('img');
        img.src = msg.media_url;
        img.alt = 'ÙˆØ³Ø§Ø¦Ø·';
        img.className = 'file-thumb';
        li.appendChild(img);
      }catch(e){
        const f = document.createElement('a');
        f.href = msg.media_url;
        f.textContent = 'ÙØªØ­ Ø§Ù„Ù…Ù„Ù';
        f.target = '_blank';
        li.appendChild(f);
      }
    }
  }

  const actions = document.createElement('div');
  actions.className = 'actions';

  const counts = {};
  const reactedByMe = {};
  if(msg.reactions && msg.reactions.length){
    msg.reactions.forEach(r=>{
      counts[r.emoji] = (counts[r.emoji] || 0) + 1;
      if(r.user_id === currentUserId) reactedByMe[r.emoji] = true;
    });
  }

  Object.keys(counts).forEach(em=>{
    const pill = document.createElement('button');
    pill.className = 'reaction-pill' + (reactedByMe[em] ? ' active' : '');
    pill.textContent = `${em} ${counts[em]}`;
    pill.onclick = (e)=>{ e.stopPropagation(); toggleReaction(msg.id, em); };
    actions.appendChild(pill);
  });

  // Ø²Ø± Ø±Ø¯ ÙˆØ§Ø¶Ø­ ÙˆÙ…ÙØµÙˆÙ„ Ø¹Ù† Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  const replyBtn = document.createElement('button');
  replyBtn.className = 'reaction-pill';
  replyBtn.textContent = 'Ø±Ø¯';
  replyBtn.onclick = (e)=>{ e.stopPropagation(); replyToMessage(msg.id); };
  actions.appendChild(replyBtn);

  // Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (Ø¨Ø¯ÙŠÙ„ Ù„Ù„Ø¶ØºØ· Ø§Ù„Ø·ÙˆÙŠÙ„)
  const reactBtn = document.createElement('button');
  reactBtn.className = 'reaction-pill';
  reactBtn.textContent = 'ğŸ˜Š';
  reactBtn.title = 'Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ø£Ùˆ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¥Ø¶Ø§ÙØ© ØªÙØ§Ø¹Ù„';
  reactBtn.onclick = (e)=>{ e.stopPropagation(); openEmojiPickerForElement(li, msg.id); };
  actions.appendChild(reactBtn);

  li.appendChild(actions);

  // long press gestures: but DO NOT prevent default to allow native scrolling
  li.addEventListener('touchstart', (ev)=>startLongPress(ev, msg.id, li));
  li.addEventListener('mousedown', (ev)=>startLongPress(ev, msg.id, li));
  li.addEventListener('touchend', cancelLongPress);
  li.addEventListener('mouseup', cancelLongPress);
  li.addEventListener('mouseleave', cancelLongPress);
  li.addEventListener('touchmove', cancelLongPress);

  // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ù„ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø³ÙŠØ·Ø© (Ù…Ø«Ø§Ù„: Ù†Ø³Ø® / Ø­Ø°Ù Ù„Ø§Ø­Ù‚Ø§Ù‹)
  li.addEventListener('dblclick', (e)=>{ e.stopPropagation(); /* Ù…ÙƒØ§Ù† Ù„ØªÙˆØ³ÙŠØ¹: ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */ });

  messagesList.appendChild(li);
}

/* ---------- long press handlers ---------- */
function startLongPress(ev, msgId, el){
  // Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… preventDefault Ù‡Ù†Ø§ Ø­ØªÙ‰ Ù„Ø§ Ù†ÙƒØ³Ø± Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ
  cancelLongPress();
  longPressTargetId = msgId;
  longPressTimer = setTimeout(()=>{
    openEmojiPickerForElement(el, msgId);
  }, 600); // 600ms Ù„Ø¶ØºØ· Ø·ÙˆÙŠÙ„
}
function cancelLongPress(){
  if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer = null; longPressTargetId = null; }
}

/* ---------- Emoji picker ---------- */
function openEmojiPickerForElement(el, msgId){
  const emojis = ['ğŸ‘','â¤ï¸','ğŸ˜‚','ğŸ”¥','ğŸ˜®','ğŸ˜¢','ğŸ‘','ğŸ‰','ğŸ˜…','ğŸ˜','ğŸ¤”','ğŸ˜´'];
  emojiPicker.innerHTML = '';
  emojis.forEach(em=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = em;
    btn.onclick = (e)=>{
      e.stopPropagation();
      addReaction(msgId, em);
      closeEmojiPicker();
    };
    btn.onkeydown = (e)=>{
      if(e.key === 'Enter') btn.click();
    };
    emojiPicker.appendChild(btn);
  });

  // ÙˆØ¶Ø¹ÙŠØ© Ø°ÙƒÙŠØ©: Ø§Ø¬Ø¹Ù„Ù‡Ø§ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø­Ø§ÙˆÙ„ ÙˆØ¶Ø¹Ù‡Ø§ Ù‚Ø±Ø¨ Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù† ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø¬Ø§Ù„
  const rect = el.getBoundingClientRect();
  const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
  const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);

  const pickerWidth = Math.min(420, vw * 0.9);
  const pickerHeight = Math.min(260, vh * 0.45);

  let top = rect.top - pickerHeight - 8;
  let left = rect.left + (rect.width / 2) - (pickerWidth / 2);

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ÙˆØ¯ØŒ Ù†Ø¶Ø¹Ù‡ Ù…Ø±ÙƒØ²ÙŠØ§Ù‹ Ø£Ùˆ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
  if(top < 8 || top + pickerHeight > vh - 8){
    top = Math.max(8, (vh - pickerHeight) / 2);
  }
  if(left < 8) left = 8;
  if(left + pickerWidth > vw - 8) left = vw - pickerWidth - 8;

  emojiPicker.style.width = pickerWidth + 'px';
  emojiPicker.style.height = 'auto';
  emojiPicker.style.left = left + 'px';
  emojiPicker.style.top = top + 'px';
  emojiPicker.style.display = 'flex';
  emojiPicker.setAttribute('aria-hidden','false');
  emojiPicker.focus();

  // Ø§Ù„Ø­Ø¨Ø³ Ø§Ù„Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ±ÙƒÙŠØ² (ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹)
  setTimeout(()=> window.addEventListener('click', closeEmojiPickerOnce), 10);
}
function closeEmojiPickerOnce(){ closeEmojiPicker(); window.removeEventListener('click', closeEmojiPickerOnce); }
function closeEmojiPicker(){ emojiPicker.style.display='none'; emojiPicker.setAttribute('aria-hidden','true'); }

/* ---------- ØªÙØ§Ø¹Ù„Ø§Øª (reactions) ---------- */
async function addReaction(chatId, emoji){
  try{
    const { data: exists, error: errExists } = await supabase
      .from('reactions')
      .select('id')
      .eq('chat_id', chatId)
      .eq('user_id', currentUserId)
      .eq('emoji', emoji)
      .maybeSingle();

    if(errExists){ console.warn('check reaction error', errExists); }

    if(exists && exists.id){
      await supabase.from('reactions').delete().eq('id', exists.id);
    } else {
      await supabase.from('reactions').insert([{ chat_id: chatId, user_id: currentUserId, emoji }]);
    }
    await loadMessages();
  }catch(err){ console.error('addReaction error', err); }
}
async function toggleReaction(chatId, emoji){ await addReaction(chatId, emoji); }

/* ---------- Ø§Ù„Ø±Ø¯ ---------- */
function replyToMessage(msgId){
  pendingReplyTo = msgId;
  // Ø¬Ù„Ø¨ Ù…Ù‚ØªØ·Ù Ù„Ù„Ø¹Ø±Ø¶ (Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹)
  const targetEl = [...messagesList.children].find(li => li.dataset.msgId == msgId);
  if(targetEl){
    const snippet = targetEl.querySelector('p') ? targetEl.querySelector('p').textContent.slice(0,160) : (targetEl.querySelector('img') ? '[ÙˆØ³Ø§Ø¦Ø·]' : '');
    replyText.textContent = snippet ? snippet + (snippet.length >= 160 ? '...' : '') : 'Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©';
    replyArea.style.display = 'flex';
    replyArea.setAttribute('aria-hidden','false');
  }
  messageInput.focus();
}
cancelReplyBtn.addEventListener('click', ()=>{
  pendingReplyTo = null;
  replyArea.style.display = 'none';
  replyArea.setAttribute('aria-hidden','true');
});

/* ---------- Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ---------- */
async function sendMessage(){
  const text = messageInput.value.trim();
  if(!text && !pendingMedia) return;
  try{
    const insertObj = {
      sender_id: currentUserId,
      message: text || '',
      reply_to: pendingReplyTo || null,
      type: pendingMedia ? pendingMedia.type : 'text',
      media_url: pendingMedia ? pendingMedia.url : null
    };
    const { data: newMsg, error: insertErr } = await supabase
      .from('chat')
      .insert([insertObj])
      .select('id, sender_id, message, media_url, type, reply_to, created_at, profiles(username)')
      .maybeSingle();

    if(insertErr){ console.error('sendMessage insertErr', insertErr); return; }

    // Ø­ÙØ¸ Ø³Ø¬Ù„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ media Ø¥Ù† ÙˆÙØ¬Ø¯Øª (Ù…Ø­Ø§ÙˆÙ„Ø© ØºÙŠØ± Ø­Ø±Ø¬Ø©)
    if(pendingMedia && newMsg && newMsg.id){
      try{
        await supabase.from('media').insert([{ chat_id: newMsg.id, media_type: pendingMedia.type, url: pendingMedia.url, name: pendingMedia.name }]);
      }catch(e){ console.warn('failed to insert to media table', e); }
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    pendingReplyTo = null;
    pendingMedia = null;
    messageInput.value = '';
    replyArea.style.display = 'none';
    attachPreview.style.display = 'none';
    previewContent.innerHTML = '';
    await loadMessages();
    messagesList.scrollTop = messagesList.scrollHeight;
  }catch(err){
    console.error('sendMessage unexpected', err);
  }
}

/* ---------- Ø±ÙØ¹ Ù…Ù„Ù Ùˆ Ù…Ø¹Ø§ÙŠÙ†Ø© ---------- */
attachBtn.addEventListener('click', async ()=>{
  const input = document.createElement('input');
  input.type = 'file';
  // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù…Ø®ØªÙ„Ù Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª
  input.accept = '*/*';
  input.onchange = async ()=>{
    if(!input.files || !input.files[0]) return;
    const f = input.files[0];
    const ext = (f.name || '').split('.').pop();
    const fileName = `${currentUserId}_${Date.now()}.${ext || 'bin'}`;

    // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±ÙŠØ©
    pendingMedia = { type: classifyFileType(f.type), url: null, name: f.name };
    renderAttachPreview(f);

    // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±ÙØ¹ ÙˆØ£Ø¸Ù‡Ø± Ù…Ø¤Ø´Ø±
    try{
      uploading = true;
      showUploadingState(true);

      const { data: uploadData, error: uploadErr } = await supabase.storage.from('chat-media').upload(fileName, f, { cacheControl: '3600', upsert: false });
      if(uploadErr){
        console.error('storage upload error', uploadErr);
        alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„ØªØ®Ø²ÙŠÙ†.');
        pendingMedia = null;
        renderAttachPreview(null);
        showUploadingState(false);
        return;
      }

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ public url Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù†Ø³Ø® SDK
      const urlRes = await supabase.storage.from('chat-media').getPublicUrl(fileName);
      const publicUrl = (urlRes && urlRes.data && (urlRes.data.publicUrl || urlRes.data.publicURL)) ? (urlRes.data.publicUrl || urlRes.data.publicURL) : (urlRes.publicUrl || '');
      const type = classifyFileType(f.type);

      pendingMedia = { type, url: publicUrl, name: f.name };
      renderAttachPreview(f, publicUrl);

    }catch(e){
      console.error('attach error', e); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù'); pendingMedia = null; renderAttachPreview(null);
    }finally{
      uploading = false;
      showUploadingState(false);
    }
  };
  input.click();
});

function classifyFileType(mime){
  if(!mime) return 'file';
  if(mime.startsWith('image')) return 'image';
  if(mime.startsWith('video')) return 'video';
  if(mime.startsWith('audio')) return 'audio';
  return 'file';
}

function renderAttachPreview(file, publicUrl){
  if(!file && !publicUrl){
    attachPreview.style.display = 'none';
    attachPreview.setAttribute('aria-hidden','true');
    previewContent.innerHTML = '';
    return;
  }
  attachPreview.style.display = 'block';
  attachPreview.setAttribute('aria-hidden','false');
  previewContent.innerHTML = '';

  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.gap = '8px';
  container.style.alignItems = 'center';

  const thumb = document.createElement('div');
  thumb.style.display = 'flex';
  thumb.style.alignItems = 'center';
  thumb.style.gap = '8px';

  if(file && file.type.startsWith('image')){
    const img = document.createElement('img');
    img.className = 'file-thumb';
    img.src = URL.createObjectURL(file);
    img.alt = file.name;
    thumb.appendChild(img);
  } else if(publicUrl && pendingMedia && pendingMedia.type === 'image'){
    const img = document.createElement('img');
    img.className = 'file-thumb';
    img.src = publicUrl;
    img.alt = file ? file.name : pendingMedia.name;
    thumb.appendChild(img);
  } else {
    const icon = document.createElement('div');
    icon.textContent = 'ğŸ“„';
    icon.style.fontSize = '28px';
    thumb.appendChild(icon);
  }

  const info = document.createElement('div');
  info.className = 'file-info';
  info.innerHTML = `<div>${(file && file.name) || (pendingMedia && pendingMedia.name) || ''}</div>`;
  if(uploading) info.innerHTML += `<div style="font-size:12px;color:#666">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...</div>`;

  const removeBtn = document.createElement('button');
  removeBtn.className = 'btn';
  removeBtn.style.width = '34px';
  removeBtn.style.height = '34px';
  removeBtn.style.background = '#eee';
  removeBtn.style.color = '#333';
  removeBtn.textContent = 'Ã—';
  removeBtn.onclick = ()=>{
    pendingMedia = null;
    renderAttachPreview(null);
  };

  container.appendChild(thumb);
  container.appendChild(info);
  container.appendChild(removeBtn);
  previewContent.appendChild(container);
}

/* ---------- Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ ---------- */
function showUploadingState(show){
  // ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¹Ø±Ø¶ progress bar Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ùˆ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± (SDK Ù…Ø­Ø¯ÙˆØ¯ Ù‡Ù†Ø§)
  const send = document.getElementById('send-btn');
  if(show){
    send.disabled = true;
    send.style.opacity = '0.5';
  } else {
    send.disabled = false;
    send.style.opacity = '1';
  }
}

/* ---------- Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª ---------- */
sendBtn.addEventListener('click', ()=> sendMessage());
messageInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

/* ---------- polling + realtime (ØªØ­Ø³Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡: Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù†ÙˆÙ‚Ù polling) ---------- */
let pollingInterval = null;
async function startPolling(){
  if(pollingInterval) clearInterval(pollingInterval);
  pollingInterval = setInterval(loadMessages, 2500);
}
loadMessages();
startPolling();

(async function tryRealtime(){
  try{
    const channel = supabase.channel('public:chat')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'chat' }, payload => {
        loadMessages();
      })
      .subscribe();

    // Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£ÙˆÙ‚Ù Ø§Ù„Ù€ polling Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
    channel.on('subscription_succeeded', () => {
      if(pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
    });
  }catch(e){
    console.warn('realtime subscribe failed (silent):', e);
  }
})();

/* ---------- Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ø²Ø± Escape ---------- */
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeEmojiPicker(); });

/* ---------- Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ…Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---------- */
/* Ù„Ù… Ù†Ù…Ù†Ø¹ default ÙÙŠ touchstartØŒ ÙƒÙ…Ø§ Ø£Ø¶ÙÙ†Ø§ touchmove Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø·ÙˆÙŠÙ„Ø› Ù‡Ø°Ø§ ÙŠØ¬Ø¹Ù„ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ */

/* ---------- service worker registration ---------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").catch(()=>{/* silent */});
}
</script>
</body>
</html>
