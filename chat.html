<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
<style>
  :root{
    --accent:#6a0572;
    --accent-2:#b5173a;
    --bubble-self: linear-gradient(135deg,var(--accent),#8a2a7a);
    --bubble-other:#ffffff;
    --text-self:#ffffff;
    --text-other:#222;
    --max-bubble-width:78%;
  }
  html,body{height:100%;margin:0;font-family:"Tahoma",sans-serif;background:#f2f2f2}
  /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
  body::before{
    content:"";
    position:fixed;inset:0;
    background-image:url('images/img.jpg');
    background-size:cover;background-position:center;
    filter:blur(6px) brightness(.55);
    z-index:0;
  }
  #app{position:relative;z-index:1;display:flex;flex-direction:column;height:100vh;backdrop-filter: none;}
  header{padding:12px 14px;color:#fff;display:flex;align-items:center;justify-content:space-between;}
  header .title{font-weight:700;font-size:18px;text-shadow:0 1px 6px rgba(0,0,0,.45)}
  #chat-container{flex:1;display:flex;flex-direction:column;padding:10px;gap:8px;max-width:920px;margin:0 auto;}
  #messages-list{flex:1;overflow:auto;padding:12px 8px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth}
  .msg { display:block; padding:10px 12px; border-radius:18px; word-break:break-word; box-shadow:0 2px 6px rgba(0,0,0,.08); max-width:var(--max-bubble-width); position:relative; display:flex;flex-direction:column; gap:6px;}
  .msg .meta{font-size:12px;opacity:.85;}
  .msg .username{font-weight:700;margin-inline-start:6px}
  .msg .time{font-size:11px;color:rgba(0,0,0,.45);margin-inline-end:6px}
  .msg.self{align-self:flex-end;background:var(--bubble-self);color:var(--text-self); border-bottom-right-radius:6px}
  .msg.other{align-self:flex-start;background:var(--bubble-other);color:var(--text-other); border-bottom-left-radius:6px}
  /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ */
  .msg img, .msg video{max-width:320px;max-height:320px;border-radius:10px;display:block}
  /* ÙÙ‚Ø§Ø¹Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·ÙˆÙŠÙ„ */
  .msg p{margin:0;white-space:pre-wrap;word-wrap:break-word}
  /* Ø²Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„ØµØºÙŠØ± */
  .msg .actions{display:flex;gap:8px;align-items:center;margin-top:4px}
  .reaction-pill{background:rgba(255,255,255,.9);padding:4px 8px;border-radius:999px;font-size:13px;box-shadow:0 1px 3px rgba(0,0,0,.08);cursor:pointer}
  /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
  #composer{display:flex;gap:8px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,.8), rgba(255,255,255,.95));backdrop-filter: blur(6px)}
  #composer input[type="text"]{flex:1;padding:12px 14px;border-radius:999px;border:1px solid rgba(0,0,0,.08);outline:none;font-size:15px}
  #composer .btn{width:44px;height:44px;border-radius:50%;border:none;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
  #composer .btn.attach{background:transparent;border:1px solid rgba(255,255,255,.14);color:#fff;backdrop-filter: blur(3px)}
  /* Ø±Ø¯ÙˆØ¯ */
  .reply-box{background:rgba(0,0,0,0.06);padding:6px 8px;border-radius:8px;font-size:13px;color:rgba(0,0,0,.7)}
  /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø¶ØºØ·Ø© Ù…Ø·ÙˆÙ„Ø©) */
  #emoji-picker{position:fixed;display:none;gap:8px;padding:8px;background:rgba(255,255,255,0.98);border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.18);z-index:50}
  #emoji-picker button{font-size:20px;padding:6px;border-radius:8px;border:none;background:transparent;cursor:pointer}
  /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù‡Ø§ØªÙ */
  @media(max-width:600px){
    :root{--max-bubble-width:92%}
    header .title{font-size:16px}
    .msg img,.msg video{max-width:72vw}
  }
</style>

  
  /* ØªØ·Ø¨ÙŠÙ‚*/

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>

body {
  background: url("images/img.jpg") no-repeat center center fixed;
  background-size: cover;
    }

    
  </style>
  
</head>
<body>
<div id="app">
  <header>
    <div class="title">Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</div>
    <div style="color:#fff;font-size:13px;opacity:.95">Ù…Ø±Ø­Ø¨Ø§ØŒ <strong id="me-name"></strong></div>
  </header>

  <main id="chat-container" role="main">
    <ul id="messages-list" aria-live="polite"></ul>

    <div id="composer">
      <button id="attach-btn" class="btn attach" title="Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©/ÙÙŠØ¯ÙŠÙˆ">+</button>
      <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." aria-label="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©">
      <button id="send-btn" class="btn" title="Ø¥Ø±Ø³Ø§Ù„">â–¶</button>
    </div>
  </main>
</div>

<!-- Emoji picker -->
<div id="emoji-picker" role="dialog" aria-hidden="true"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
  // --- Ø¥Ø¹Ø¯Ø§Ø¯ Supabase ---
  const SUPABASE_URL = "https://hmamaaqtnzevrrmgtgxk.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtYW1hYXF0bnpldnJybWd0Z3hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTgzMDAsImV4cCI6MjA3NzkzNDMwMH0.tk_S2URpkYvf8xnsPJl3Dqh4jzKwhVm0alWl8oHo-SE";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† localStorage
  const currentUserId = localStorage.getItem('chat_user_id');
  const currentUsername = localStorage.getItem('chat_username');
  if(!currentUserId || !currentUsername){
    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø› Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.');
    window.location.href = 'login.html';
  }
  document.getElementById('me-name').textContent = currentUsername;

  // Ø¹Ù†Ø§ØµØ±
  const messagesList = document.getElementById('messages-list');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const attachBtn = document.getElementById('attach-btn');
  const emojiPicker = document.getElementById('emoji-picker');

  // Ù…Ø¤Ù‚Øª Ù„Ø¶ØºØ· Ù…Ø·ÙˆÙ„
  let longPressTimer = null;
  let longPressTargetId = null;

  // --- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø¹Ø±Ø¨ÙŠ Ù…Ø®ØªØµØ± ---
  function formatTime(iso){
    try{
      const d = new Date(iso);
      // use user's locale (Arabic) â€” using options for concise form
      return d.toLocaleString('ar-EG', { hour:'2-digit', minute:'2-digit' });
    }catch(e){ return iso; }
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ØªÙØ§Ø¹Ù„Ø§Øª)
  async function loadMessages(){
    try{
      const { data, error } = await supabase
        .from('chat')
        .select('id,sender_id,message,media_url,type,reply_to,created_at, profiles(username), reactions(id,emoji,user_id)')
        .order('created_at', { ascending: true });

      if(error){ console.error('loadMessages error', error); return; }
      messagesList.innerHTML = '';
      // Ø­ÙØ¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ØªØ³Ù‡ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø±Ø¯
      const msgMap = {};
      data.forEach(m => msgMap[m.id] = m);

      data.forEach(msg => renderMessage(msg, msgMap));
      // ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
      messagesList.scrollTop = messagesList.scrollHeight;
    }catch(err){
      console.error('unexpected loadMessages', err);
    }
  }

  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙØ±Ø¯ÙŠØ©
  function renderMessage(msg, msgMap = {}){
    const li = document.createElement('li');
    li.className = 'msg ' + (msg.sender_id === currentUserId ? 'self' : 'other');
    li.dataset.msgId = msg.id;

    // Ø±Ø£Ø³ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: Ø§Ø³Ù… + ÙˆÙ‚Øª
    const meta = document.createElement('div');
    meta.className = 'meta';
    const nameSpan = document.createElement('span');
    nameSpan.className = 'username';
    nameSpan.textContent = (msg.profiles && msg.profiles.username) ? msg.profiles.username : 'Ù…Ø³ØªØ®Ø¯Ù…';
    const timeSpan = document.createElement('span');
    timeSpan.className = 'time';
    timeSpan.textContent = formatTime(msg.created_at);
    // ØªØ±ØªÙŠØ¨ meta (Ø§Ø³Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† ÙˆÙ‚Øª Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±)
    meta.appendChild(nameSpan);
    meta.appendChild(timeSpan);

    li.appendChild(meta);

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„Ø© Ø±Ø¯ØŒ Ø¹Ø±Ø¶ Ù…Ù‚ØªØ·Ù Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‡Ø¯Ù
    if(msg.reply_to){
      const original = msgMap[msg.reply_to];
      const replyBox = document.createElement('div');
      replyBox.className = 'reply-box';
      replyBox.textContent = original ? (`Ø±Ø¯ Ø¹Ù„Ù‰ ${original.profiles?.username || 'Ù…Ø³ØªØ®Ø¯Ù…'}: ${original.message ? original.message.slice(0,140) : (original.media_url ? '[ÙˆØ³Ø§Ø¦Ø·]' : '')}`) : 'Ø±Ø¯';
      li.appendChild(replyBox);
    }

    // Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    if(msg.message && msg.message.trim() !== ''){
      const p = document.createElement('p');
      p.textContent = msg.message;
      li.appendChild(p);
    }

    // ÙˆØ³Ø§Ø¦Ø· (ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ)
    if(msg.media_url){
      if(msg.type === 'video'){
        const v = document.createElement('video');
        v.src = msg.media_url;
        v.controls = true;
        v.style.maxWidth = '100%';
        v.style.borderRadius = '8px';
        li.appendChild(v);
      } else {
        const img = document.createElement('img');
        img.src = msg.media_url;
        img.alt = 'ØµÙˆØ±Ø©';
        img.style.maxWidth = '100%';
        li.appendChild(img);
      }
    }

    // Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª â€” Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙˆÙ†Ø³Ø¨ØªÙ‡Ø§
    const actions = document.createElement('div');
    actions.className = 'actions';
    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ ÙƒÙ„ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    const counts = {};
    if(msg.reactions && msg.reactions.length){
      msg.reactions.forEach(r=>{
        counts[r.emoji] = (counts[r.emoji] || 0) + 1;
      });
    }
    // Ø£Ù†Ø´Ø¦ Ø£Ø²Ø±Ø§Ø± Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ØµØºÙŠØ±Ø©
    Object.keys(counts).forEach(em=>{
      const pill = document.createElement('button');
      pill.className = 'reaction-pill';
      pill.textContent = `${em} ${counts[em]}`;
      pill.onclick = (e)=>{ e.stopPropagation(); toggleReaction(msg.id, em); };
      actions.appendChild(pill);
    });

    // Ø²Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø·ÙˆÙ„ Ù„ÙØªØ­ pickerØŒ Ù„ÙƒÙ† Ù†Ø¶ÙŠÙ Ø²Ø± Ø³Ø±ÙŠØ¹ Ø£ÙŠØ¶Ø§Ù‹
    const replyBtn = document.createElement('button');
    replyBtn.className = 'reaction-pill';
    replyBtn.textContent = 'Ø±Ø¯';
    replyBtn.onclick = (e)=>{ e.stopPropagation(); replyToMessage(msg.id); };
    actions.appendChild(replyBtn);

    li.appendChild(actions);

    // Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø¶ØºØ· Ø§Ù„Ø·ÙˆÙŠÙ„ Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    li.addEventListener('touchstart', (ev)=>startLongPress(ev, msg.id, li));
    li.addEventListener('mousedown', (ev)=>startLongPress(ev, msg.id, li));
    li.addEventListener('touchend', cancelLongPress);
    li.addEventListener('mouseup', cancelLongPress);
    li.addEventListener('mouseleave', cancelLongPress);

    // Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙŠØ¶Ø¹ Ø±Ø¯Ù‘
    li.addEventListener('click', ()=> replyToMessage(msg.id));

    messagesList.appendChild(li);
  }

  // Ø¨Ø¯Ø¡ Ù…Ø¤Ù‚Øª Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø·ÙˆÙŠÙ„
  function startLongPress(ev, msgId, el){
    ev.preventDefault?.();
    cancelLongPress();
    longPressTargetId = msgId;
    longPressTimer = setTimeout(()=>{
      openEmojiPickerForElement(el, msgId);
    }, 500); // 500ms Ù„Ø¶ØºØ· Ø·ÙˆÙŠÙ„
  }
  function cancelLongPress(){
    if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer = null; longPressTargetId = null; }
  }

  // ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ØµØºÙŠØ±Ø© Ù‚Ø±Ø¨ Ø§Ù„Ø¹Ù†ØµØ±
  function openEmojiPickerForElement(el, msgId){
    // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (ÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹Ù‡Ø§)
    const emojis = ['ğŸ‘','â¤ï¸','ğŸ˜‚','ğŸ”¥','ğŸ˜®','ğŸ˜¢'];
    emojiPicker.innerHTML = '';
    emojis.forEach(em=>{
      const btn = document.createElement('button');
      btn.textContent = em;
      btn.onclick = (e)=>{
        e.stopPropagation();
        addReaction(msgId, em);
        closeEmojiPicker();
      };
      emojiPicker.appendChild(btn);
    });
    // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù†ØµØ±
    const rect = el.getBoundingClientRect();
    const pickerWidth = 220;
    const top = Math.max(10, rect.top - 60);
    const left = Math.max(10, rect.left - (pickerWidth/2) + (rect.width/2));
    emojiPicker.style.left = left + 'px';
    emojiPicker.style.top = top + 'px';
    emojiPicker.style.display = 'flex';
    emojiPicker.setAttribute('aria-hidden','false');
    // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†
    setTimeout(()=> window.addEventListener('click', closeEmojiPickerOnce), 10);
  }
  function closeEmojiPickerOnce(){ closeEmojiPicker(); window.removeEventListener('click', closeEmojiPickerOnce); }
  function closeEmojiPicker(){ emojiPicker.style.display='none'; emojiPicker.setAttribute('aria-hidden','true'); }

  // Ø¥Ø¶Ø§ÙØ© ØªÙØ§Ø¹Ù„
  async function addReaction(chatId, emoji){
    try{
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ ÙØ¹Ù„ Ù†ÙØ³ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù†Ø­Ø°ÙÙ‡
      const { data: exists } = await supabase
        .from('reactions')
        .select('id')
        .eq('chat_id', chatId)
        .eq('user_id', currentUserId)
        .eq('emoji', emoji)
        .maybeSingle();

      if(exists){
        await supabase.from('reactions').delete().eq('id', exists.id);
      } else {
        await supabase.from('reactions').insert([{ chat_id: chatId, user_id: currentUserId, emoji }]);
      }
      await loadMessages();
    }catch(err){ console.error('addReaction error', err); }
  }

  // ØªØ¨Ø¯ÙŠÙ„ ØªÙØ§Ø¹Ù„ Ø³Ø±ÙŠØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­Ø¨Ø©
  async function toggleReaction(chatId, emoji){
    await addReaction(chatId, emoji);
  }

  // ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¯
  let pendingReplyTo = null;
  function replyToMessage(msgId){
    pendingReplyTo = msgId;
    messageInput.focus();
    messageInput.placeholder = 'Ø£Ù†Øª ØªØ±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© â€” Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯';
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©
  async function sendMessage(){
    const text = messageInput.value.trim();
    if(!text && !pendingMedia) return;
    try{
      // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø¥Ø±Ø³Ø§Ù„ reply_to Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯)
      const insertObj = {
        sender_id: currentUserId,
        message: text || '',
        reply_to: pendingReplyTo || null,
        type: pendingMedia ? pendingMedia.type : 'text',
        media_url: pendingMedia ? pendingMedia.url : null
      };
      const { data: newMsg, error: insertErr } = await supabase
        .from('chat')
        .insert([insertObj])
        .select('id, sender_id, message, media_url, type, reply_to, created_at, profiles(username)')
        .maybeSingle();

      if(insertErr){ console.error('sendMessage insertErr', insertErr); return; }

      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙ†Ø§ ÙˆØ³Ø§Ø¦Ø·ØŒ Ø£Ø¯Ø®Ù„ Ø³Ø¬Ù„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ media Ù…Ø±ØªØ¨Ø·Ù‹Ø§ Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      if(pendingMedia && newMsg && newMsg.id){
        try{
          await supabase.from('media').insert([{ chat_id: newMsg.id, media_type: pendingMedia.type, url: pendingMedia.url }]);
        }catch(e){ console.warn('failed to insert to media table', e); }
      }

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
      pendingReplyTo = null;
      pendingMedia = null;
      messageInput.value = '';
      messageInput.placeholder = 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...';
      await loadMessages();
      messagesList.scrollTop = messagesList.scrollHeight;
    }catch(err){
      console.error('sendMessage unexpected', err);
    }
  }

  // Ø§Ù„ØªÙ‚Ø§Ø· Ù…Ù„Ù ÙˆØ±ÙØ¹Ù‡ Ø«Ù… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·
  let pendingMedia = null; // { type, url }
  attachBtn.addEventListener('click', async ()=>{
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,video/*';
    input.onchange = async ()=>{
      if(!input.files || !input.files[0]) return;
      const f = input.files[0];
      const ext = f.name.split('.').pop();
      const fileName = `${currentUserId}_${Date.now()}.${ext}`;
      try{
        const { data: uploadData, error: uploadErr } = await supabase.storage.from('chat-media').upload(fileName, f, { cacheControl: '3600', upsert: false });
        if(uploadErr){
          console.error('storage upload error', uploadErr);
          alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„ØªØ®Ø²ÙŠÙ†.');
          return;
        }
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ public url
        const urlRes = await supabase.storage.from('chat-media').getPublicUrl(fileName);
        const publicUrl = (urlRes && urlRes.data && (urlRes.data.publicUrl || urlRes.data.publicURL)) ? (urlRes.data.publicUrl || urlRes.data.publicURL) : (urlRes.publicUrl || '');
        // type
        const type = f.type.startsWith('image') ? 'image' : 'video';
        // Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ù…Ø¤Ù‚ØªØ§Ù‹ ÙˆØ£Ø±Ø³Ù„Ù‡Ø§ Ø¹Ø¨Ø± sendMessage
        pendingMedia = { type, url: publicUrl };
        // Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¨Ø§Ø´Ø± (Ø¨Ø¯ÙˆÙ† Ù†Øµ) â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ù„ÙˆÙƒ Ù„ÙƒØªØ§Ø¨Ø© Ù†Øµ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        await sendMessage();
      }catch(e){ console.error('attach error', e); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù'); }
    };
    input.click();
  });

  // Ø­Ø¯Ø« Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  sendBtn.addEventListener('click', ()=> sendMessage());
  messageInput.addEventListener('keypress', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); sendMessage(); } });

  // polling Ø¨Ø³ÙŠØ· ÙƒÙ„ 2.5 Ø«Ø§Ù†ÙŠØ© + ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ
  loadMessages();
  setInterval(loadMessages, 2500);

  // ØªØ­Ø³ÙŠÙ†: Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Realtime (Ø¥Ù† Ø£Ø±Ø¯Øª Ø£Ù‚Ù„ Ø­Ù…Ù„ ÙˆØ¨Ø£Ø¯Ø§Ø¡ Ø£ÙØ¶Ù„)
  // Ù…Ù„Ø§Ø­Ø¸Ø©: Supabase Realtime ÙŠØªØ·Ù„Ø¨ ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ùˆ/Ø£Ùˆ Ù‚ÙˆØ§Ø¹Ø¯ Row Level Security.
  try{
    const channel = supabase.channel('public:chat')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'chat' }, payload => {
        // Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ (Ø£Ùˆ Ø¶Ù…Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©)
        loadMessages();
      })
      .subscribe();
  }catch(e){
    // Ø¥Ù† ÙØ´Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙ„Ø§ Ù…Ø´ÙƒÙ„Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ polling
    console.warn('realtime subscribe failed (silent):', e);
  }

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ emoji picker Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Escape
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeEmojiPicker(); });

  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù†
  messageInput.addEventListener('focus', ()=>{ if(pendingReplyTo === null) messageInput.placeholder = 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...'; });

</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
  
</body>
</html>
