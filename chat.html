<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
<style>
body { margin:0; font-family: "Tahoma", sans-serif; background:#f0f0f0; display:flex; flex-direction:column; height:100vh; }
#chat-container { flex:1; display:flex; flex-direction:column; padding:10px; overflow:hidden; }
#messages-list { flex:1; overflow-y:auto; padding:0; margin:0; list-style:none; }
#messages-list li { margin:5px 0; padding:8px 12px; border-radius:15px; position:relative; word-wrap:break-word; max-width:75%; display:inline-block; }
#messages-list li.self { background:#6a0572; color:#fff; align-self:flex-end; margin-left:auto; text-align:right; }
#messages-list li.other { background:#ddd; color:#000; align-self:flex-start; margin-right:auto; text-align:left; }
#messages-list li.admin { background:#fffae5; color:#555; align-self:center; text-align:center; }
li .username { font-weight:bold; font-size:12px; margin-bottom:2px; display:block; }
li .time { font-size:10px; color:#555; margin-top:3px; display:block; }
li .reply { font-size:12px; color:#555; margin-bottom:3px; font-style:italic; border-left:2px solid #ccc; padding-left:4px; }
.reactions { font-size:14px; margin-top:4px; cursor:pointer; }
#message-input-area { display:flex; padding:10px; background:#fff; align-items:center; }
#message-input-area input[type="text"] { flex:1; padding:10px 12px; border-radius:20px; border:1px solid #ccc; outline:none; }
#attach-btn { margin-inline-start:8px; padding:10px 16px; border:none; border-radius:50%; cursor:pointer; background:#6a0572; color:#fff; font-size:18px; }
#send-btn { width:36px; height:36px; margin-inline-start:8px; background:#6a0572; border:none; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; }
#send-btn::before { content:''; display:block; width:0; height:0; border-left:12px solid #fff; border-top:6px solid transparent; border-bottom:6px solid transparent; }
#emoji-picker { position:absolute; bottom:60px; right:10px; background:#fff; border:1px solid #ccc; border-radius:10px; padding:5px; display:none; flex-wrap:wrap; max-width:200px; z-index:1000; }
#emoji-picker span { cursor:pointer; font-size:20px; margin:3px; }
</style>
</head>
<body>

<div id="chat-container">
  <ul id="messages-list"></ul>
  <div id="message-input-area">
    <button id="attach-btn">+</button>
    <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
    <button id="send-btn"></button>
    <div id="emoji-picker"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
const SUPABASE_URL = "https://hmamaaqtnzevrrmgtgxk.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtYW1hYXF0bnpldnJybWd0Z3hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTgzMDAsImV4cCI6MjA3NzkzNDMwMH0.tk_S2URpkYvf8xnsPJl3Dqh4jzKwhVm0alWl8oHo-SE";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
const currentUserId = localStorage.getItem('chat_user_id');
const currentUsername = localStorage.getItem('chat_username');
const currentUserRole = localStorage.getItem('chat_user_role') || 'user';
if(!currentUserId || !currentUsername){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'); window.location.href='login.html'; }

// Ø¹Ù†Ø§ØµØ±
const messagesList = document.getElementById('messages-list');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const attachBtn = document.getElementById('attach-btn');
const emojiPicker = document.getElementById('emoji-picker');

let replyToId = null;
let replyMessageText = null;

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
const emojiList = ['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ˜¡','ðŸŽ‰','ðŸ™Œ','ðŸ”¥','ðŸ’¯'];
emojiList.forEach(e=>{
  const span = document.createElement('span');
  span.textContent = e;
  span.onclick = ()=>{ messageInput.value += e; emojiPicker.style.display='none'; messageInput.focus(); };
  emojiPicker.appendChild(span);
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
async function loadMessages(){
  const { data, error } = await supabaseClient
    .from('chat')
    .select('*, sender_id(username, role), reactions(*)')
    .order('created_at', { ascending:true });
  if(error){ console.error(error); return; }
  messagesList.innerHTML = '';
  data.forEach(renderMessage);
  messagesList.scrollTop = messagesList.scrollHeight;
}

// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
function renderMessage(msg){
  const li = document.createElement('li');
  // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  if(msg.sender_id.role==='admin' && msg.message.startsWith('@System')){
    li.className = 'admin';
  } else {
    li.className = msg.sender_id.id===currentUserId?'self':'other';
  }

  let content = `<span class="username">${msg.sender_id.username}</span>`;
  if(msg.reply_to && msg.reply_to_message) content += `<div class="reply">${msg.reply_to_message}</div>`;
  if(msg.media_url){
    content += `<br><${msg.type==='image'?'img':'video'} src="${msg.media_url}" ${msg.type==='video'?'controls':''} style="max-width:200px;border-radius:8px;">`;
  }
  content += `<div>${msg.message}</div>`;
  content += `<span class="time">${new Date(msg.created_at).toLocaleTimeString()}</span>`;

  li.innerHTML = content;

  // Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
  const reactionsDiv = document.createElement('div');
  reactionsDiv.className = 'reactions';
  reactionsDiv.textContent = msg.reactions?.map(r=>r.emoji).join(' ') || '';
  reactionsDiv.onclick = (e)=>{ e.stopPropagation(); toggleReaction(msg.id); };
  li.appendChild(reactionsDiv);

  li.onclick = ()=>{ replyToId=msg.id; replyMessageText=msg.message; messageInput.focus(); };
  messagesList.appendChild(li);
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
async function sendMessage(){
  const text = messageInput.value.trim();
  if(!text && !replyToId) return;
  const { data, error } = await supabaseClient
    .from('chat')
    .insert([{ sender_id: currentUserId, message:text, reply_to:replyToId }])
    .select()
    .maybeSingle();
  if(error){ console.error(error); return; }
  renderMessage(data);
  messageInput.value=''; replyToId=null; replyMessageText=null;
  messagesList.scrollTop = messagesList.scrollHeight;
}
sendBtn.onclick=sendMessage;
messageInput.addEventListener('keypress', e=>{ if(e.key==='Enter'){ sendMessage(); e.preventDefault(); } });

// Ø±ÙØ¹ Ù…Ù„ÙØ§Øª
attachBtn.onclick = async ()=>{
  const file = document.createElement('input');
  file.type='file';
  file.accept='image/*,video/*';
  file.onchange=async ()=>{
    if(!file.files[0]) return;
    const f=file.files[0];
    const ext=f.name.split('.').pop();
    const fileName = `${currentUserId}_${Date.now()}.${ext}`;
    const { data: storageData, error } = await supabaseClient.storage.from('chat-media').upload(fileName,f);
    if(error){ console.error(error); return; }
    const url = supabaseClient.storage.from('chat-media').getPublicUrl(fileName).publicUrl;
    const type = f.type.startsWith('image')?'image':'video';
    const { data: msgData, error: msgErr } = await supabaseClient
      .from('chat')
      .insert([{ sender_id:currentUserId,message:'', type, media_url:url }])
      .select()
      .maybeSingle();
    if(msgErr){ console.error(msgErr); return; }
    renderMessage(msgData);
    messagesList.scrollTop = messagesList.scrollHeight;
  }
  file.click();
}

// Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©
async function toggleReaction(chatId){
  const emoji = prompt('Ø£Ø¯Ø®Ù„ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ'); // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ù€ picker ÙƒØ§Ù…Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹
  if(!emoji) return;
  const { data: exists } = await supabaseClient
    .from('reactions')
    .select('id')
    .eq('chat_id', chatId)
    .eq('user_id', currentUserId)
    .eq('emoji', emoji)
    .maybeSingle();
  if(exists){
    await supabaseClient.from('reactions').delete().eq('id', exists.id);
  } else {
    await supabaseClient.from('reactions').insert([{ chat_id: chatId, user_id: currentUserId, emoji }]);
  }
  loadMessages();
}

// Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
messageInput.addEventListener('focus', ()=>{ emojiPicker.style.display='flex'; });
document.body.addEventListener('click', e=>{ if(!e.target.closest('#message-input-area')) emojiPicker.style.display='none'; });

// ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ + ØªØ­Ø¯ÙŠØ«
loadMessages();
setInterval(loadMessages,3000);
</script>

</body>
</html>
